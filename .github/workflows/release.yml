name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in pom.xml
        run: mvn versions:set -DnewVersion=${{ steps.get_version.outputs.VERSION }} -DgenerateBackupPoms=false -DnvdApiKey=${{ secrets.NVD_API_KEY }}

      - name: Run tests
        run: mvn -B test -DnvdApiKey=${{ secrets.NVD_API_KEY }}

      - name: Build and package
        run: mvn -B clean package -DskipTests -DnvdApiKey=${{ secrets.NVD_API_KEY }}

      - name: Rename JAR for release
        run: |
          mv target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar

      - name: Generate checksums
        run: |
          cd target
          sha256sum mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar > mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar.sha256

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          # Extrae las notas de la versión actual del CHANGELOG
          VERSION=${{ steps.get_version.outputs.VERSION }}
          NOTES=$(awk "/## \[${VERSION}\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md)
          
          # Si no hay notas específicas, usa un mensaje genérico
          if [ -z "$NOTES" ]; then
            NOTES="Release v${VERSION}"
          fi
          
          # Guarda en archivo para evitar problemas con caracteres especiales
          echo "$NOTES" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: MCP Server Poncho v${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          files: |
            target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar
            target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}.jar.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job opcional para build nativo con GraalVM
  native-build:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !contains(github.ref, '-rc') && !contains(github.ref, '-beta') && !contains(github.ref, '-alpha') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update version in pom.xml
        run: mvn versions:set -DnewVersion=${{ steps.get_version.outputs.VERSION }} -DgenerateBackupPoms=false -DnvdApiKey=${{ secrets.NVD_API_KEY }}

      - name: Build native image
        run: mvn -B -Pnative native:compile -DskipTests -DnvdApiKey=${{ secrets.NVD_API_KEY }}
        continue-on-error: true

      - name: Rename and checksum native binary
        if: success()
        run: |
          if [ -f target/mcp-server-poncho ]; then
            mv target/mcp-server-poncho target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}-linux-amd64
            cd target
            sha256sum mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}-linux-amd64 > mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}-linux-amd64.sha256
          fi

      - name: Upload native binary to release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}-linux-amd64
            target/mcp-server-poncho-${{ steps.get_version.outputs.VERSION }}-linux-amd64.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
